//
//  GBTopLineView.m
//  æ·˜å®å‚ç›´è·‘é©¬ç¯å¹¿å‘Š
//
//  Created by å¼ å›½å…µ on 15/8/28.
//  Copyright (c) 2015å¹´ zhangguobing. All rights reserved.
//

#import "GBTopLineView.h"
#import "TestView.h"
@interface GBTopLineView(){
    
    NSTimer *_timer;     //å®šæ—¶å™¨
    int count;  // å“ªä¸ª modle
    int page; // å“ªä¸€é¡µ
    int flag; //æ ‡è¯†å½“å‰æ˜¯å“ªä¸ªviewæ˜¾ç¤º(currentView/hidenView)
    NSMutableArray *_dataArr;
}
@property (nonatomic,strong) UIView *currentView;   //å½“å‰æ˜¾ç¤ºçš„view
@property (nonatomic,strong) UIView *hidenView;     //åº•éƒ¨è—èµ·çš„view

@property (nonatomic,strong) TestView *currentTest;
@property (nonatomic,strong) TestView *hiddenTest;

@end
@implementation GBTopLineView
-(NSMutableArray *)dataArr{
    if (!_dataArr) {
        _dataArr = [[NSMutableArray alloc]init];
    }
    return _dataArr;
}
- (id)initWithFrame:(CGRect)frame
{
    self = [super initWithFrame:frame];
    if (self) {
        [self createUI];
    }
    return self;
}

- (void)createUI
{
    count = 0;
    flag = 0;
  
    
    self.layer.masksToBounds = YES;

    //åˆ›å»ºå®šæ—¶å™¨
    
    [self createCurrentView];
    [self createHidenView];
//    NSLog(@" ğŸŒğŸŒğŸŒğŸŒ%@, ğŸ™„%@",NSStringFromCGRect(self.currentView.frame),NSStringFromCGRect(self.hidenView.frame));
       [self createTimer];
    
}
- (void)layoutSubviews{
    [super layoutSubviews];
    
    
}
- (void)setDataArr:(NSMutableArray *)dataArr{
    _dataArr = dataArr;
    
    DataModel *currentTopModel = _dataArr[count];
    DataModel *currentBottomModel;
    currentBottomModel = _dataArr[count + 1];

    self.currentTest.topModel = currentTopModel;
    self.currentTest.bottomModel = currentBottomModel;

}

- (void)createTimer
{
    _timer=[NSTimer scheduledTimerWithTimeInterval:3.0 target:self selector:@selector(dealTimer) userInfo:nil repeats:YES];
}

#pragma mark - è·‘é©¬ç¯æ“ä½œ
-(void)dealTimer
{
    
    count += 2;
    if (count >= _dataArr.count) {
        count = 0;
    }

    
    // è¦å¢åŠ åˆ¤æ–­ count + 1 æ²¡æœ‰å€¼çš„æƒ…å†µä¸‹
    if (flag == 1) {
        // currernt èµ‹å€¼
        
        DataModel *currentTopModel = _dataArr[count];
        DataModel *currentBottomModel;
        if(count + 1 >= _dataArr.count){
            currentBottomModel = nil;
        }
        currentBottomModel = _dataArr[count + 1];
        self.currentTest.topModel = currentTopModel;
        self.currentTest.bottomModel = currentBottomModel;
        

    }
    
    if (flag == 0) {
        //hidden èµ‹å€¼
        DataModel *hienTopModel = _dataArr[count];
        DataModel *hiddenBottomModel;
        if(count + 1 >= _dataArr.count){
            hiddenBottomModel = nil;
        }
        hiddenBottomModel = _dataArr[count + 1];
        
        self.hiddenTest.topModel = hienTopModel;
        self.hiddenTest.bottomModel = hiddenBottomModel;

    }
    if (flag == 0) {
        [UIView animateWithDuration:0.5 animations:^{
            self.currentView.frame = CGRectMake(0, -self.frame.size.height, self.frame.size.width, self.frame.size.height);
        } completion:^(BOOL finished) {
            flag = 1;
            self.currentView.frame = CGRectMake(0, self.frame.size.height, self.frame.size.width, self.frame.size.height);
        }];
        [UIView animateWithDuration:0.5 animations:^{
            self.hidenView.frame = CGRectMake(0, 0, self.frame.size.width, self.frame.size.height);
        } completion:^(BOOL finished) {
            
        }];
    }else{
        
        [UIView animateWithDuration:0.5 animations:^{
            self.hidenView.frame = CGRectMake(0, -self.frame.size.height, self.frame.size.width, self.frame.size.height);
        } completion:^(BOOL finished) {
            flag = 0;
            self.hidenView.frame = CGRectMake(0, self.frame.size.height, self.frame.size.width, self.frame.size.width);
        }];
        [UIView animateWithDuration:0.5 animations:^{
            self.currentView.frame = CGRectMake(0, 0, self.frame.size.width, self.frame.size.height);
        } completion:^(BOOL finished) {
            
        }];
    }
}

- (void)createCurrentView
{
    DataModel *topModel = _dataArr[count];
    DataModel *bottomModel;
    if (count + 1 >= _dataArr.count) {
        bottomModel = nil;
    }
    bottomModel = _dataArr[count + 1];


    self.currentView = [[UIView alloc]initWithFrame:CGRectMake(0, 0, self.frame.size.width, self.frame.size.height)];
    [self addSubview:self.currentView];
   
    self.currentTest = [[[NSBundle mainBundle]loadNibNamed:NSStringFromClass([TestView class]) owner:nil options:nil]lastObject];
    self.currentTest.frame = CGRectMake(0, 0, self.frame.size.width, self.frame.size.height);
    self.currentTest.topModel = topModel;
    self.currentTest.bottomModel = bottomModel;

    [self.currentView addSubview:self.currentTest];
}

- (void)createHidenView
{   DataModel *topModel = _dataArr[count];
    DataModel *bottomModel;
    if (count + 1 >= _dataArr.count) {
        bottomModel = nil;
    }
    bottomModel = _dataArr[count + 1];

    self.hidenView = [[UIView alloc]initWithFrame:CGRectMake(0, self.frame.size.height , self.frame.size.width, self.frame.size.height)];
    [self addSubview:self.hidenView];
    
    self.hiddenTest = [[[NSBundle mainBundle]loadNibNamed:NSStringFromClass([TestView class]) owner:nil options:nil]lastObject];
    self.hiddenTest.frame = self.hidenView.bounds;
    
    self.hiddenTest.topModel = topModel;
    self.hiddenTest.bottomModel = bottomModel;
    [self.hidenView addSubview:self.hiddenTest];

}

#pragma mark - åœæ­¢å®šæ—¶å™¨
- (void)stopTimer
{
    //åœæ­¢å®šæ—¶å™¨
    //åœ¨invalidateä¹‹å‰æœ€å¥½å…ˆç”¨isValidå…ˆåˆ¤æ–­æ˜¯å¦è¿˜åœ¨çº¿ç¨‹ä¸­ï¼š
    if ([_timer isValid] == YES) {
        [_timer invalidate];
        _timer = nil;
    }
}

@end
